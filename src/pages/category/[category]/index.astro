---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const cats = Array.from(
    new Set(posts.filter(p => !p.data.draft).map(p => p.data.category).filter(Boolean))
  );

  return cats.map((category) => ({
    params: { category }, // IMPORTANT: do not encode here
    props: { category },
  }));
}

const { category } = Astro.props;

const posts = (await getCollection("posts"))
  .filter(p => !p.data.draft && p.data.category === category)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<BaseLayout>
  <section class="pagehead">
    <div>
      <h1 class="page-title">Category: {category}</h1>
      <p class="page-sub">{posts.length} post(s)</p>
    </div>
    <a class="cta ghost" href="/blog/">Back to blog</a>
  </section>

  <div class="cards">
    {posts.map(post => (
      <article class="post-card">
        <h2 class="post-title">
          <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
        </h2>
        <p class="meta">{post.data.pubDate.toDateString()} · {post.data.category}</p>
        <p class="desc">{post.data.description}</p>
        <div class="readmore">
          <a class="read" href={`/blog/${post.slug}/`}>Read article →</a>
        </div>
      </article>
    ))}
  </div>
</BaseLayout>
