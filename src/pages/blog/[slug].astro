---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { SITE } from "../../consts";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((p) => ({
    params: { slug: p.slug },
    props: { post: p },
  }));
}

const { post } = Astro.props;

const title = post.data.title;
const description = post.data.description;
const canonical = new URL(`/blog/${post.slug}/`, SITE.url).toString();
const image = post.data.featuredImage
  ? new URL(post.data.featuredImage, SITE.url).toString()
  : "";
const pubDateISO = post.data.pubDate.toISOString();

// Related posts (same category)
const allPosts = (await getCollection("posts"))
  .filter((p) => !p.data.draft);

const related = allPosts
  .filter((p) => p.slug !== post.slug && p.data.category === post.data.category)
  .slice(0, 3);

// Draft handling
const robots = post.data.draft ? "noindex,nofollow" : "index,follow";
---

<BaseLayout title={title} description={description}>
  <head>
    <link rel="canonical" href={canonical} />
    <meta name="robots" content={robots} />

    <meta property="og:type" content="article" />
    <meta property="og:title" content={`${title} | ${SITE.name}`} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    {image && <meta property="og:image" content={image} />}
    {image && <meta name="twitter:image" content={image} />}

    <meta property="article:published_time" content={pubDateISO} />
    <meta property="article:section" content={post.data.category} />

    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        headline: title,
        description,
        image: image || undefined,
        datePublished: pubDateISO,
        dateModified: pubDateISO,
        mainEntityOfPage: canonical,
        url: canonical,
        author: { "@type": "Organization", name: SITE.name },
        publisher: { "@type": "Organization", name: SITE.name },
      })}
    />
  </head>

  <article class="article">
    <header class="article-head">
      <p class="kicker">
        <a class="meta-link" href={`/category/${post.data.category}/`}>{post.data.category}</a>
        <span> · </span>
        <time datetime={pubDateISO}>{post.data.pubDate.toDateString()}</time>
      </p>

      <h1 class="article-title">{title}</h1>
      <p class="article-desc">{description}</p>

      {post.data.tags?.length ? (
        <div class="tags">
          {post.data.tags.slice(0, 10).map((t) => (
            <a class="tag" href={`/tag/${t}/`}>{t}</a>
          ))}
        </div>
      ) : null}

      {image ? <img class="article-img" src={post.data.featuredImage} alt={title} loading="eager" /> : null}
    </header>

    <div class="prose">
      <post.Content />
    </div>

    {related.length ? (
      <section class="related">
        <h2>Related</h2>
        <div class="cards">
          {related.map((p) => (
            <article class="post-card">
              <h3 class="post-title">
                <a href={`/blog/${p.slug}/`}>{p.data.title}</a>
              </h3>
              <p class="meta">{p.data.pubDate.toDateString()} · {p.data.category}</p>
              <p class="desc">{p.data.description}</p>
            </article>
          ))}
        </div>
      </section>
    ) : null}
  </article>
</BaseLayout>
